<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Researcher - AssignSavvy</title>
  <link rel="icon" type="image/svg+xml" href="./assets/favicon.svg">
  <link rel="stylesheet" href="./styles/main.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
  <div class="dashboard-layout">
    <!-- Top Bar -->
    <div class="dashboard-topbar">
      <div class="topbar-left">
        <button class="sidebar-toggle" id="sidebar-toggle">
          <i class="fas fa-bars"></i>
        </button>
        <div class="topbar-logo">
          ðŸ“š AssignSavvy
        </div>
      </div>
      <div class="topbar-title">Smart Researcher</div>
      <div class="topbar-actions">
        <button class="notification-btn" id="notification-btn">
          <i class="fas fa-bell"></i>
          <div class="notification-badge"></div>
        </button>
        <a href="index.html" class="home-btn">
          <i class="fas fa-home"></i>
          <span>Home</span>
        </a>
      </div>
    </div>
    
    <!-- Sidebar -->
    <div class="dashboard-sidebar" id="dashboard-sidebar">
      <!-- Navigation -->
      <ul class="sidebar-nav">
        <li>
          <a href="dashboard.html" class="sidebar-nav-item">
            <i class="fas fa-chart-line"></i>
            <span>Dashboard</span>
          </a>
        </li>
        <li>
          <a href="writer.html" class="sidebar-nav-item">
            <i class="fas fa-pen"></i>
            <span>Writer</span>
          </a>
        </li>
        <li>
          <a href="researcher.html" class="sidebar-nav-item active">
            <i class="fas fa-magnifying-glass"></i>
            <span>Researcher</span>
          </a>
        </li>
        <li>
          <a href="detector.html" class="sidebar-nav-item">
            <i class="fas fa-shield-halved"></i>
            <span>Originality Detector</span>
          </a>
        </li>
        <li>
          <a href="prompt-engineer.html" class="sidebar-nav-item">
            <i class="fas fa-code"></i>
            <span>Prompt Engineer</span>
          </a>
        </li>
        <li>
          <a href="history.html" class="sidebar-nav-item">
            <i class="fas fa-clock-rotate-left"></i>
            <span>History</span>
          </a>
        </li>
      </ul>
      
      <!-- User Account Info -->
      <div class="user-account-info">
        <div class="user-profile-card" id="user-profile-card" style="cursor: pointer;">
          <div class="user-avatar">
            <i class="fas fa-user-circle"></i>
          </div>
          <div class="user-details">
            <h4 id="user-name">User Name</h4>
            <p class="user-plan" id="user-plan">Free Plan</p>
            <div class="user-credits">
              <i class="fas fa-coins"></i>
              <span id="user-credits">145/200 Credits</span>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Main Content -->
    <div class="dashboard-content">
      <!-- Header -->
      <div class="section-header">
        <h2>Smart Researcher</h2>
        <button class="btn btn-outline" id="open-history-btn">
          <i class="fas fa-history"></i> History
        </button>
      </div>
      
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Research Input Section -->
        <div class="card">
          <h3 class="mb-4">Research Query</h3>
          
          <!-- Research Type Selection -->
          <div class="form-group mb-4">
            <label>Research Type</label>
            <div class="flex flex-wrap gap-2 mb-2">
              <button class="btn btn-outline btn-sm active" data-type="general">General</button>
              <button class="btn btn-outline btn-sm" data-type="academic">Academic</button>
              <button class="btn btn-outline btn-sm" data-type="technical">Technical</button>
              <button class="btn btn-outline btn-sm" data-type="market">Market</button>
              <button class="btn btn-outline btn-sm" data-type="scientific">Scientific</button>
            </div>
          </div>
          
          <!-- Research Query Input -->
          <div class="form-group mb-4">
            <label for="research-query">Research Topic</label>
            <textarea id="research-query" class="form-input" rows="6" placeholder="Enter your research question or topic..."></textarea>
            <div class="text-right text-sm text-gray mt-1">0 words</div>
          </div>
          
          <!-- Research Depth -->
          <div class="form-group mb-4">
            <label for="research-depth">Research Depth</label>
            <select id="research-depth" class="form-input">
              <option value="1">Basic Overview (1/5)</option>
              <option value="2">Moderate Detail (2/5)</option>
              <option value="3" selected>Comprehensive (3/5)</option>
              <option value="4">In-depth (4/5)</option>
              <option value="5">Exhaustive (5/5)</option>
            </select>
          </div>
          
          <!-- Preferred Sources -->
          <div class="form-group mb-6">
            <label>Preferred Source Types</label>
            <div class="grid grid-cols-2 gap-2">
              <label class="checkbox-container">
                <input type="checkbox" value="academic" checked>
                <span class="checkmark"></span>
                Academic Papers
              </label>
              <label class="checkbox-container">
                <input type="checkbox" value="books" checked>
                <span class="checkmark"></span>
                Books
              </label>
              <label class="checkbox-container">
                <input type="checkbox" value="news">
                <span class="checkmark"></span>
                News Articles
              </label>
              <label class="checkbox-container">
                <input type="checkbox" value="government">
                <span class="checkmark"></span>
                Government Reports
              </label>
            </div>
          </div>
          
          <button class="btn btn-primary w-full" id="research-btn">
            <i class="fas fa-search"></i> Start Research
          </button>
        </div>
        
        <!-- Research Results Section -->
        <div class="card">
          <div class="flex justify-between items-center mb-4">
            <h3>Research Results</h3>
            <div class="flex gap-2" id="results-actions" style="display: none;">
              <button class="btn btn-icon" id="export-btn" title="Export results">
                <i class="fas fa-download"></i>
              </button>
              <button class="btn btn-icon" id="save-research-btn" title="Save to history">
                <i class="fas fa-save"></i>
              </button>
            </div>
          </div>
          
          <!-- Initial State -->
          <div id="no-results" class="text-center py-12">
            <i class="fas fa-search text-4xl text-gray mb-4"></i>
            <h4>Ready to Research</h4>
            <p class="text-gray">Enter your research query to get started</p>
          </div>
          
          <!-- Loading State -->
          <div id="loading-research" style="display: none;" class="text-center py-12">
            <div class="spinner mb-4"></div>
            <h4>Conducting Research...</h4>
            <p class="text-gray" id="research-progress">Analyzing your query</p>
          </div>
          
          <!-- Results State -->
          <div id="research-results" style="display: none;">
            <div class="research-content">
              <!-- Executive Summary -->
              <div class="result-section mb-6">
                <h4 class="mb-2">Executive Summary</h4>
                <div id="executive-summary" class="content-text"></div>
              </div>
              
              <!-- Main Findings -->
              <div class="result-section mb-6">
                <h4 class="mb-2">Main Findings</h4>
                <div id="main-findings" class="content-text"></div>
              </div>
              
              <!-- Key Insights -->
              <div class="result-section mb-6">
                <h4 class="mb-2">Key Insights</h4>
                <div id="key-insights" class="content-text"></div>
              </div>
              
              <!-- Sources -->
              <div class="result-section mb-6">
                <h4 class="mb-2">Sources (<span id="source-count">0</span>)</h4>
                <div id="sources-list" class="space-y-2"></div>
              </div>
              
              <!-- Research Stats -->
              <div class="research-stats mt-6 p-4 bg-gray-50 rounded-lg">
                <div class="grid grid-cols-2 gap-4 text-sm">
                  <div>
                    <span class="font-medium">Word Count:</span>
                    <span id="research-word-count">0</span>
                  </div>
                  <div>
                    <span class="font-medium">Credits Used:</span>
                    <span id="research-credits-used">0</span>
                  </div>
                  <div>
                    <span class="font-medium">Processing Time:</span>
                    <span id="research-time">0s</span>
                  </div>
                  <div>
                    <span class="font-medium">Quality Score:</span>
                    <span id="quality-score">N/A</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Export Modal -->
  <div id="export-modal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Export Research</h3>
        <button id="close-export-modal" class="btn-close">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group mb-4">
          <label>Export Format</label>
          <div class="grid grid-cols-2 gap-2">
            <label class="radio-container">
              <input type="radio" name="export-format" value="json" checked>
              <span class="radio-mark"></span>
              JSON
            </label>
            <label class="radio-container">
              <input type="radio" name="export-format" value="txt">
              <span class="radio-mark"></span>
              Text
            </label>
            <label class="radio-container">
              <input type="radio" name="export-format" value="markdown">
              <span class="radio-mark"></span>
              Markdown
            </label>
            <label class="radio-container">
              <input type="radio" name="export-format" value="pdf">
              <span class="radio-mark"></span>
              PDF
            </label>
          </div>
        </div>
        <button class="btn btn-primary w-full" id="download-export-btn">
          <i class="fas fa-download"></i> Download Export
        </button>
      </div>
    </div>
  </div>

  <!-- User Profile Modal -->
  <div id="user-profile-modal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3>User Profile</h3>
        <button id="close-profile-modal" class="btn-close">&times;</button>
      </div>
      <div class="modal-body">
        <div class="profile-section">
          <div class="profile-avatar">
            <i class="fas fa-user-circle text-6xl text-primary"></i>
          </div>
          <div class="profile-info">
            <h4 id="modal-user-name">User Name</h4>
            <p class="text-gray" id="modal-user-email">john.doe@example.com</p>
            <div class="plan-info">
              <span class="plan-badge" id="modal-user-plan">Free Plan</span>
              <div class="credits-info">
                <i class="fas fa-coins text-orange"></i>
                <span id="modal-user-credits">145/200 Credits</span>
              </div>
            </div>
          </div>
        </div>
        <div class="profile-actions">
          <button class="btn btn-outline" onclick="window.location.href='auth.html'">Account Settings</button>
          <button class="btn btn-primary" onclick="window.location.href='pricing.html'">Upgrade Plan</button>
          <button class="btn btn-outline" onclick="logout()">Logout</button>
        </div>
      </div>
    </div>
  </div>

  <script src="./js/userSession.js"></script>
  <script>
    // Global variables
    let currentResearchType = 'general';
    let currentResearchId = null;
    let isResearching = false;

    // API helper functions
    function getAuthToken() {
      return localStorage.getItem('authToken') || 'mock-token';
    }

    async function makeAuthenticatedRequest(url, options = {}) {
      const token = getAuthToken();
      return fetch(url, {
        ...options,
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`,
          ...options.headers
        }
      });
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
      initializeEventListeners();
      updateWordCount();
    });

    function initializeEventListeners() {
      // Research type selection
      document.querySelectorAll('[data-type]').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('[data-type]').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          currentResearchType = this.dataset.type;
        });
      });

      // Word count tracking
      document.getElementById('research-query').addEventListener('input', updateWordCount);

      // Research button
      document.getElementById('research-btn').addEventListener('click', startResearch);

      // Export functionality
      document.getElementById('export-btn').addEventListener('click', () => {
        document.getElementById('export-modal').style.display = 'flex';
      });

      document.getElementById('close-export-modal').addEventListener('click', () => {
        document.getElementById('export-modal').style.display = 'none';
      });

      document.getElementById('download-export-btn').addEventListener('click', downloadExport);

      // Save research button
      document.getElementById('save-research-btn').addEventListener('click', saveResearchToHistory);

      // History button
      document.getElementById('open-history-btn').addEventListener('click', openResearchHistory);

      // Sidebar functionality
      initializeSidebar();
    }

    function updateWordCount() {
      const query = document.getElementById('research-query').value;
      const wordCount = query.trim() ? query.trim().split(/\s+/).length : 0;
      document.querySelector('.text-right').textContent = `${wordCount} words`;
    }

    async function startResearch() {
      if (isResearching) return;

      const query = document.getElementById('research-query').value.trim();
      const depth = parseInt(document.getElementById('research-depth').value);

      if (!query) {
        alert('Please enter a research query');
        return;
      }

      // Get selected source types
      const sourceCheckboxes = document.querySelectorAll('input[type="checkbox"]:checked');
      const sources = Array.from(sourceCheckboxes).map(cb => cb.value);

      try {
        isResearching = true;
        showResearchLoading('Analyzing your research query...');

        const requestData = {
          query,
          researchType: currentResearchType,
          depth,
          sources,
          saveToHistory: true
        };

        const response = await makeAuthenticatedRequest('/api/research/query', {
          method: 'POST',
          body: JSON.stringify(requestData)
        });

        const result = await response.json();

        if (!response.ok) {
          throw new Error(result.error || 'Research failed');
        }

        if (result.success) {
          displayResearchResults(result.data);
          currentResearchId = result.data.researchId;
          updateUserCredits(result.data.metadata.creditsUsed, result.data.metadata.newBalance);
        } else {
          throw new Error(result.error || 'Research failed');
        }

      } catch (error) {
        console.error('Research error:', error);
        showResearchError(error.message);
      } finally {
        isResearching = false;
        hideResearchLoading();
      }
    }

    function displayResearchResults(data) {
      document.getElementById('no-results').style.display = 'none';
      document.getElementById('research-results').style.display = 'block';
      document.getElementById('results-actions').style.display = 'flex';

      // Display research content
      const results = data.results;
      
      document.getElementById('executive-summary').innerHTML = formatContent(results.executiveSummary || 'No summary available');
      document.getElementById('main-findings').innerHTML = formatContent(results.mainFindings || 'No findings available');
      document.getElementById('key-insights').innerHTML = formatContent(results.keyInsights || 'No insights available');

      // Display sources
      const sourcesList = document.getElementById('sources-list');
      const sources = results.sources || [];
      document.getElementById('source-count').textContent = sources.length;

      sourcesList.innerHTML = '';
      sources.forEach((source, index) => {
        const sourceItem = document.createElement('div');
        sourceItem.className = 'source-item p-3 border rounded-lg';
        sourceItem.innerHTML = `
          <div class="flex justify-between items-start">
            <div class="flex-1">
              <h6 class="font-medium mb-1">${source.title || `Source ${index + 1}`}</h6>
              <p class="text-sm text-gray mb-2">${source.citation || 'No citation available'}</p>
              ${source.url ? `<a href="${source.url}" target="_blank" class="text-blue-600 text-sm hover:underline">
                <i class="fas fa-external-link-alt"></i> View Source
              </a>` : ''}
            </div>
            <div class="ml-4">
              <span class="badge ${getReliabilityBadgeClass(source.reliability)}">${source.reliability || 'Unknown'}</span>
            </div>
          </div>
        `;
        sourcesList.appendChild(sourceItem);
      });

      // Update stats
      document.getElementById('research-word-count').textContent = data.metadata.wordCount || 0;
      document.getElementById('research-credits-used').textContent = data.metadata.creditsUsed || 0;
      document.getElementById('research-time').textContent = `${((data.metadata.processingTime || 0) / 1000).toFixed(1)}s`;
      document.getElementById('quality-score').textContent = data.results.qualityScore || 'N/A';
    }

    function formatContent(content) {
      if (!content) return 'No content available';
      
      // Convert line breaks to HTML
      return content.replace(/\n/g, '<br>');
    }

    function getReliabilityBadgeClass(reliability) {
      switch (reliability?.toLowerCase()) {
        case 'high': return 'badge-success';
        case 'medium': return 'badge-warning';
        case 'low': return 'badge-danger';
        default: return 'badge-secondary';
      }
    }

    function showResearchLoading(message) {
      document.getElementById('no-results').style.display = 'none';
      document.getElementById('research-results').style.display = 'none';
      document.getElementById('loading-research').style.display = 'block';
      document.getElementById('research-progress').textContent = message;
      document.getElementById('research-btn').disabled = true;
      document.getElementById('research-btn').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Researching...';
    }

    function hideResearchLoading() {
      document.getElementById('loading-research').style.display = 'none';
      document.getElementById('research-btn').disabled = false;
      document.getElementById('research-btn').innerHTML = '<i class="fas fa-search"></i> Start Research';
    }

    function showResearchError(message) {
      document.getElementById('loading-research').style.display = 'none';
      document.getElementById('no-results').style.display = 'block';
      alert(`Research Error: ${message}`);
    }

    async function downloadExport() {
      if (!currentResearchId) {
        alert('No research results to export');
        return;
      }

      try {
        const format = document.querySelector('input[name="export-format"]:checked').value;
        
        const response = await makeAuthenticatedRequest(`/api/research/export/${currentResearchId}`, {
          method: 'POST',
          body: JSON.stringify({ format })
        });

        if (!response.ok) {
          throw new Error('Export failed');
        }

        // Handle file download
        const blob = await response.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `research-export-${currentResearchId}.${format}`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        document.getElementById('export-modal').style.display = 'none';
        showNotification('Research exported successfully!');

      } catch (error) {
        console.error('Export error:', error);
        alert('Failed to export research results');
      }
    }

    async function saveResearchToHistory() {
      if (!currentResearchId) {
        alert('No research results to save');
        return;
      }

      try {
        showNotification('Research already saved to history!');
      } catch (error) {
        console.error('Save error:', error);
        alert('Failed to save research to history');
      }
    }

    async function openResearchHistory() {
      try {
        const response = await makeAuthenticatedRequest('/api/research/history?limit=10');
        const result = await response.json();

        if (result.success) {
          displayResearchHistory(result.data.history);
        } else {
          throw new Error(result.error || 'Failed to load history');
        }

      } catch (error) {
        console.error('History error:', error);
        alert('Failed to load research history');
      }
    }

    function displayResearchHistory(history) {
      // Simple history display - could be enhanced with a proper modal
      if (history.length === 0) {
        alert('No research history found');
        return;
      }

      let historyText = 'Recent Research:\n\n';
      history.slice(0, 5).forEach((item, index) => {
        const date = new Date(item.timestamp?.toDate()).toLocaleDateString();
        historyText += `${index + 1}. ${item.query} (${date})\n`;
      });

      alert(historyText);
    }

    function updateUserCredits(creditsUsed, newBalance) {
      if (window.userSession) {
        // Use server-provided balance if available, otherwise calculate locally
        const finalBalance = newBalance !== undefined ? newBalance : (() => {
          const currentUser = window.userSession.getCurrentUser();
          return Math.max(0, currentUser.credits - (creditsUsed || 0));
        })();
        
        window.userSession.updateUser({ credits: finalBalance });
        console.log(`Credits updated: Used ${creditsUsed}, New balance: ${finalBalance}`);
      }
    }

    function showNotification(message) {
      const notification = document.createElement('div');
      notification.className = 'notification';
      notification.textContent = message;
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #10b981;
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        z-index: 1000;
        animation: slideIn 0.3s ease;
      `;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.remove();
      }, 3000);
    }

    function initializeSidebar() {
      const sidebarToggle = document.getElementById('sidebar-toggle');
      const sidebar = document.getElementById('dashboard-sidebar');
      const dashboardLayout = document.querySelector('.dashboard-layout');
      
      sidebarToggle.addEventListener('click', function() {
        if (window.innerWidth <= 768) {
          sidebar.classList.toggle('sidebar-open');
          dashboardLayout.classList.toggle('sidebar-active');
        } else {
          dashboardLayout.classList.toggle('sidebar-collapsed');
        }
      });
      
      document.addEventListener('click', function(event) {
        if (window.innerWidth <= 768) {
          if (!sidebar.contains(event.target) && !sidebarToggle.contains(event.target) && sidebar.classList.contains('sidebar-open')) {
            sidebar.classList.remove('sidebar-open');
            dashboardLayout.classList.remove('sidebar-active');
          }
        }
      });
      
      window.addEventListener('resize', function() {
        if (window.innerWidth > 768) {
          sidebar.classList.remove('sidebar-open');
          dashboardLayout.classList.remove('sidebar-active');
        } else {
          dashboardLayout.classList.remove('sidebar-collapsed');
        }
      });

      // User profile modal
      document.getElementById('user-profile-card').addEventListener('click', function() {
        document.getElementById('user-profile-modal').style.display = 'flex';
      });
      
      document.getElementById('close-profile-modal').addEventListener('click', function() {
        document.getElementById('user-profile-modal').style.display = 'none';
      });
      
      document.getElementById('user-profile-modal').addEventListener('click', function(e) {
        if (e.target === this) {
          this.style.display = 'none';
        }
      });
    }

    // CSS for animations and styling
    const style = document.createElement('style');
    style.textContent = `
      .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f4f6;
        border-top: 4px solid #3b82f6;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto;
      }
      
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      
      @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      
      .content-text {
        line-height: 1.6;
        color: #374151;
      }
      
      .source-item {
        transition: all 0.3s ease;
      }
      
      .source-item:hover {
        background-color: #f9fafb;
        transform: translateX(5px);
      }
      
      .badge-success { background: #10b981; color: white; }
      .badge-warning { background: #f59e0b; color: white; }
      .badge-danger { background: #ef4444; color: white; }
      .badge-secondary { background: #6b7280; color: white; }
      
      .badge {
        padding: 0.25rem 0.5rem;
        border-radius: 0.375rem;
        font-size: 0.75rem;
        font-weight: 500;
      }
    `;
    document.head.appendChild(style);
  </script>
</body>
</html>